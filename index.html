<!DOCTYPE html>
<html lang="es">
    <head>
        <meta charset="UTF-8" />
        <meta
            name="viewport"
            content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes"
        />
        <meta name="description" content="Sistema de registro de pedidos" />
        <meta name="theme-color" content="#800b96" />
        <meta name="mobile-web-app-capable" content="yes" />
        <meta name="apple-mobile-web-app-capable" content="yes" />
        <meta
            name="apple-mobile-web-app-status-bar-style"
            content="black-translucent"
        />
        <title>Sistema de Pedidos - PaginaWebPedidosPS</title>
        <link rel="stylesheet" href="css/styles.css" />
    </head>
    <body>
        <header role="banner">
            <div class="header-content">
                <div class="logo-title">
                    <img
                        src="assets/images/logo-purple-shop.png"
                        alt="Purple Shop Logo"
                        class="logo"
                    />
                    <h1>Purple Shop - Registro de Pedidos</h1>
                </div>
                <div class="header-actions">
                    <div
                        id="offlineIndicator"
                        class="offline-indicator"
                        style="display: none"
                    >
                        üî¥ Modo Offline
                    </div>
                    <button
                        id="loginBtn"
                        class="btn-primary"
                        aria-label="Iniciar sesi√≥n con Microsoft"
                    >
                        Conectar con OneDrive
                    </button>
                    <span
                        id="userInfo"
                        class="user-info"
                        aria-live="polite"
                    ></span>
                </div>
            </div>
        </header>

        <!-- Navegaci√≥n por Pesta√±as -->
        <nav
            class="tabs-navigation"
            role="navigation"
            aria-label="Navegaci√≥n principal"
        >
            <button
                class="tab-btn active"
                data-tab="newOrder"
                onclick="switchTab('newOrder')"
            >
                üè† Nuevo Pedido
            </button>
            <button
                class="tab-btn"
                data-tab="clients"
                onclick="switchTab('clients')"
            >
                üë• Clientes
            </button>
            <button
                class="tab-btn"
                data-tab="orders"
                onclick="switchTab('orders')"
            >
                üì¶ Pedidos
            </button>
            <button
                class="tab-btn"
                data-tab="reports"
                onclick="switchTab('reports')"
            >
                üìä Reportes
            </button>
        </nav>

        <main role="main">
            <!-- Pesta√±a: Nuevo Pedido -->
            <section
                class="tab-content active"
                id="newOrder"
                aria-labelledby="form-title"
            >
                <div class="form-container">
                    <h2 id="form-title">Nuevo Pedido</h2>

                    <form id="orderForm" aria-label="Formulario de pedido">
                        <!-- Fecha del Pedido -->
                        <fieldset>
                            <legend>Informaci√≥n del Pedido</legend>
                            <div class="form-group">
                                <label for="orderDate">
                                    Fecha del Pedido
                                    <span
                                        class="required"
                                        aria-label="requerido"
                                        >*</span
                                    >
                                </label>
                                <input
                                    type="date"
                                    id="orderDate"
                                    name="orderDate"
                                    required
                                    aria-required="true"
                                />
                            </div>
                        </fieldset>

                        <!-- Datos del Cliente -->
                        <fieldset>
                            <legend>Datos del Cliente</legend>

                            <!-- Clientes Favoritos -->
                            <div
                                class="form-group"
                                id="favoriteClientsSection"
                                style="display: none"
                            >
                                <label>‚≠ê Clientes Frecuentes</label>
                                <div
                                    id="favoriteClientsButtons"
                                    class="favorite-clients-grid"
                                >
                                    <!-- Botones de clientes favoritos cargados din√°micamente -->
                                </div>
                            </div>

                            <div class="form-group client-search-group">
                                <label for="clientSearch">
                                    Buscar Cliente
                                </label>
                                <div class="search-with-button">
                                    <input
                                        type="text"
                                        id="clientSearch"
                                        list="clientsList"
                                        placeholder="Buscar cliente existente o escribir nombre nuevo..."
                                        oninput="selectExistingClient()"
                                        onblur="checkClientExists()"
                                        autocomplete="off"
                                    />
                                    <datalist id="clientsList">
                                        <!-- Clientes cargados din√°micamente -->
                                    </datalist>
                                    <button
                                        type="button"
                                        class="btn-secondary btn-small"
                                        onclick="switchTab('clients')"
                                        title="Gestionar clientes"
                                    >
                                        üë• Clientes
                                    </button>
                                </div>
                                <div
                                    id="newClientSuggestion"
                                    style="display: none"
                                    class="client-suggestion"
                                >
                                    <span>‚ö†Ô∏è Cliente no encontrado. </span>
                                    <button
                                        type="button"
                                        class="btn-primary btn-small"
                                        onclick="quickAddClient()"
                                    >
                                        ‚ûï Agregar Cliente
                                    </button>
                                </div>
                            </div>

                            <div class="form-group">
                                <label for="clientName">
                                    Nombre del Cliente
                                    <span
                                        class="required"
                                        aria-label="requerido"
                                        >*</span
                                    >
                                </label>
                                <input
                                    type="text"
                                    id="clientName"
                                    name="clientName"
                                    required
                                    aria-required="true"
                                    autocomplete="name"
                                />
                            </div>

                            <div class="form-group">
                                <label for="clientPhone">
                                    Tel√©fono
                                    <span
                                        class="required"
                                        aria-label="requerido"
                                        >*</span
                                    >
                                </label>
                                <input
                                    type="tel"
                                    id="clientPhone"
                                    name="clientPhone"
                                    required
                                    aria-required="true"
                                    autocomplete="tel"
                                    inputmode="tel"
                                    pattern="[0-9\s\-\+\(\)]+"
                                />
                            </div>

                            <div class="form-group">
                                <label for="clientEmail">
                                    Correo Electr√≥nico
                                </label>
                                <input
                                    type="email"
                                    id="clientEmail"
                                    name="clientEmail"
                                    autocomplete="email"
                                />
                            </div>

                            <div class="form-group">
                                <label for="clientAddress">
                                    Direcci√≥n de Entrega
                                    <span
                                        class="required"
                                        aria-label="requerido"
                                        >*</span
                                    >
                                </label>
                                <textarea
                                    id="clientAddress"
                                    name="clientAddress"
                                    rows="3"
                                    required
                                    aria-required="true"
                                    autocomplete="street-address"
                                ></textarea>
                            </div>
                        </fieldset>

                        <!-- Productos -->
                        <fieldset>
                            <legend>Productos</legend>

                            <!-- Secci\u00f3n de c\u00f3digos guardados -->
                            <div
                                class="saved-codes-info"
                                id="savedCodesInfo"
                                style="display: none"
                            >
                                <div class="info-header">
                                    <span
                                        >\u26a1 C\u00f3digos R\u00e1pidos
                                        Guardados</span
                                    >
                                    <button
                                        type="button"
                                        onclick="toggleSavedCodes()"
                                        class="btn-toggle-codes"
                                    >
                                        Ver <span id="codesCount">0</span>
                                    </button>
                                </div>
                                <div
                                    id="savedCodesList"
                                    class="saved-codes-list"
                                    style="display: none"
                                >
                                    <!-- Lista de c\u00f3digos cargada din\u00e1micamente -->
                                </div>
                            </div>

                            <div
                                id="productsContainer"
                                role="list"
                                aria-label="Lista de productos"
                            >
                                <div class="product-item" role="listitem">
                                    <div class="form-group">
                                        <label for="category_0">
                                            Categor√≠a
                                            <span
                                                class="required"
                                                aria-label="requerido"
                                                >*</span
                                            >
                                        </label>
                                        <select
                                            id="category_0"
                                            name="category[]"
                                            required
                                            aria-required="true"
                                            class="category-select"
                                            onchange="updateProductFields(0)"
                                        >
                                            <option value="">
                                                Seleccionar categor√≠a
                                            </option>
                                            <option value="accesorios">
                                                Accesorios
                                            </option>
                                            <option value="medias">
                                                Medias
                                            </option>
                                            <option value="camisetas">
                                                Camisetas
                                            </option>
                                            <option value="perfumes">
                                                Perfumes o Lociones
                                            </option>
                                        </select>
                                    </div>

                                    <div class="form-group">
                                        <label for="productCode_0">
                                            C√≥digo R√°pido
                                            <small
                                                style="
                                                    font-weight: normal;
                                                    color: #666;
                                                "
                                                >‚ö° Opcional - Ej: A001</small
                                            >
                                        </label>
                                        <input
                                            type="text"
                                            id="productCode_0"
                                            name="productCode[]"
                                            placeholder="C√≥digo r√°pido (Ej: A001)"
                                            oninput="handleProductCodeInput(0)"
                                            autocomplete="off"
                                        />
                                    </div>

                                    <div class="form-group">
                                        <label for="product_0">
                                            Producto
                                            <span
                                                class="required"
                                                aria-label="requerido"
                                                >*</span
                                            >
                                        </label>
                                        <input
                                            type="text"
                                            id="product_0"
                                            name="product[]"
                                            required
                                            aria-required="true"
                                            placeholder="Nombre del producto"
                                        />
                                    </div>

                                    <div class="form-group">
                                        <label for="productImage_0">
                                            Imagen del Producto (URL)
                                            <small
                                                style="
                                                    font-weight: normal;
                                                    color: #666;
                                                "
                                                >üì∏ Opcional</small
                                            >
                                        </label>
                                        <input
                                            type="url"
                                            id="productImage_0"
                                            name="productImage[]"
                                            placeholder="https://ejemplo.com/imagen.jpg"
                                        />
                                    </div>

                                    <!-- Campos espec√≠ficos por categor√≠a -->
                                    <div
                                        id="dynamicFields_0"
                                        class="dynamic-fields"
                                    ></div>

                                    <div class="form-group">
                                        <label for="quantity_0">
                                            Cantidad
                                            <span
                                                class="required"
                                                aria-label="requerido"
                                                >*</span
                                            >
                                        </label>
                                        <input
                                            type="number"
                                            id="quantity_0"
                                            name="quantity[]"
                                            min="1"
                                            value="1"
                                            required
                                            aria-required="true"
                                            inputmode="numeric"
                                            class="quantity-input"
                                        />
                                    </div>

                                    <div class="form-group">
                                        <label for="unitPrice_0">
                                            Precio Unitario
                                            <span
                                                class="required"
                                                aria-label="requerido"
                                                >*</span
                                            >
                                        </label>
                                        <input
                                            type="number"
                                            id="unitPrice_0"
                                            name="unitPrice[]"
                                            min="0"
                                            step="1000"
                                            placeholder="Ej: 50000"
                                            required
                                            aria-required="true"
                                            inputmode="numeric"
                                            class="unit-price-input"
                                        />
                                    </div>

                                    <div class="form-group">
                                        <label for="totalPrice_0">
                                            Precio Total
                                        </label>
                                        <input
                                            type="number"
                                            id="totalPrice_0"
                                            name="totalPrice[]"
                                            readonly
                                            aria-readonly="true"
                                            class="total-price-input"
                                            tabindex="-1"
                                        />
                                    </div>

                                    <!-- Bot\u00f3n para guardar c\u00f3digo -->
                                    <div
                                        class="form-group"
                                        style="margin-top: 0.5rem"
                                    >
                                        <button
                                            type="button"
                                            onclick="saveCurrentProductAsCode()"
                                            class="btn-save-code"
                                            title="Guardar este producto con su c\u00f3digo para uso futuro"
                                        >
                                            \ud83d\udcbe Guardar C\u00f3digo
                                            R\u00e1pido
                                        </button>
                                    </div>

                                    <button
                                        type="button"
                                        class="btn-remove"
                                        aria-label="Eliminar producto"
                                        style="display: none"
                                    >
                                        ‚úï
                                    </button>
                                </div>
                            </div>

                            <button
                                type="button"
                                id="addProductBtn"
                                class="btn-secondary"
                                aria-label="Agregar otro producto"
                            >
                                + Agregar Producto
                            </button>
                        </fieldset>

                        <!-- Calculadora de Descuentos y Env√≠o -->
                        <fieldset>
                            <legend>üí∞ Ajustes al Total</legend>
                            <div
                                class="form-group"
                                style="
                                    display: flex;
                                    gap: 20px;
                                    align-items: flex-start;
                                    flex-wrap: wrap;
                                "
                            >
                                <div style="flex: 1; min-width: 200px">
                                    <label for="discount">Descuento (%)</label>
                                    <input
                                        type="number"
                                        id="discount"
                                        name="discount"
                                        min="0"
                                        max="100"
                                        step="1"
                                        value="0"
                                        placeholder="Ej: 10"
                                        inputmode="numeric"
                                        oninput="updateGrandTotal()"
                                    />
                                    <small class="field-hint"
                                        >Porcentaje de descuento sobre el
                                        subtotal</small
                                    >
                                </div>
                                <div style="flex: 1; min-width: 200px">
                                    <label for="shippingCost"
                                        >Costo de Env√≠o ($)</label
                                    >
                                    <input
                                        type="number"
                                        id="shippingCost"
                                        name="shippingCost"
                                        min="0"
                                        step="1000"
                                        value="0"
                                        placeholder="Ej: 5000"
                                        inputmode="numeric"
                                        oninput="updateGrandTotal()"
                                    />
                                    <small class="field-hint"
                                        >Costo adicional de env√≠o</small
                                    >
                                </div>
                            </div>
                        </fieldset>

                        <!-- Total General -->
                        <div class="total-section" aria-live="polite">
                            <div
                                style="
                                    display: flex;
                                    flex-direction: column;
                                    gap: 10px;
                                    padding: 15px;
                                    background: linear-gradient(
                                        135deg,
                                        #f5f5f5,
                                        #e8e8e8
                                    );
                                    border-radius: 8px;
                                "
                            >
                                <div
                                    style="
                                        display: flex;
                                        justify-content: space-between;
                                        font-size: 0.95em;
                                        color: #666;
                                    "
                                >
                                    <span>Subtotal Productos:</span>
                                    <span id="subtotal">$ 0</span>
                                </div>
                                <div
                                    style="
                                        display: none;
                                        justify-content: space-between;
                                        font-size: 0.95em;
                                        color: #107c10;
                                    "
                                    id="discountRow"
                                >
                                    <span
                                        >Descuento (<span id="discountPercent"
                                            >0</span
                                        >%):</span
                                    >
                                    <span id="discountAmount">- $ 0</span>
                                </div>
                                <div
                                    style="
                                        display: none;
                                        justify-content: space-between;
                                        font-size: 0.95em;
                                        color: #666;
                                    "
                                    id="shippingRow"
                                >
                                    <span>Costo de Env√≠o:</span>
                                    <span id="shippingAmount">+ $ 0</span>
                                </div>
                                <hr
                                    style="
                                        border: none;
                                        border-top: 2px solid #800b96;
                                        margin: 5px 0;
                                    "
                                />
                                <div
                                    style="
                                        display: flex;
                                        justify-content: space-between;
                                        font-size: 1.3em;
                                        font-weight: bold;
                                        color: #800b96;
                                    "
                                >
                                    <span>Total del Pedido:</span>
                                    <span id="grandTotal">$ 0</span>
                                </div>
                            </div>
                        </div>

                        <!-- Notas Adicionales -->
                        <fieldset>
                            <legend>Notas Adicionales</legend>
                            <div class="form-group">
                                <label for="notes"> Observaciones </label>
                                <textarea
                                    id="notes"
                                    name="notes"
                                    rows="4"
                                    placeholder="Agregar cualquier informaci√≥n adicional sobre el pedido"
                                ></textarea>
                            </div>
                        </fieldset>

                        <!-- Notificaci√≥n por Email -->
                        <fieldset>
                            <legend>Notificaciones</legend>
                            <div class="form-group">
                                <label class="checkbox-label">
                                    <input
                                        type="checkbox"
                                        id="sendEmailNotification"
                                        name="sendEmailNotification"
                                    />
                                    <span
                                        >üìß Enviar confirmaci√≥n por email al
                                        cliente</span
                                    >
                                </label>
                                <small class="field-hint"
                                    >Se enviar√° un email con los detalles del
                                    pedido</small
                                >
                            </div>
                        </fieldset>

                        <!-- Botones de acci√≥n -->
                        <div class="form-actions">
                            <button
                                type="submit"
                                class="btn-primary btn-submit"
                                id="submitBtn"
                            >
                                Guardar Pedido
                            </button>
                            <button
                                type="reset"
                                class="btn-secondary"
                                aria-label="Limpiar formulario"
                            >
                                Limpiar
                            </button>
                        </div>
                    </form>
                </div>
            </section>

            <!-- Pesta√±a: Gesti√≥n de Clientes -->
            <section class="tab-content" id="clients">
                <div class="form-container">
                    <h2>Gesti√≥n de Clientes</h2>
                    <div class="clients-actions">
                        <button
                            type="button"
                            class="btn-primary"
                            id="newClientBtn"
                            onclick="showNewClientForm()"
                        >
                            ‚ûï Nuevo Cliente
                        </button>
                        <button
                            type="button"
                            class="btn-primary"
                            id="loadClientsBtn"
                            onclick="loadClients()"
                        >
                            Cargar Clientes
                        </button>
                        <button
                            type="button"
                            class="btn-secondary"
                            onclick="toggleClientsManagement()"
                        >
                            Cerrar
                        </button>
                    </div>

                    <!-- Formulario para nuevo cliente -->
                    <div
                        id="newClientForm"
                        class="new-client-form"
                        style="display: none"
                    >
                        <h3>Registrar Nuevo Cliente</h3>
                        <div class="form-grid">
                            <div class="form-group">
                                <label for="newClientName">
                                    Nombre Completo
                                    <span class="required">*</span>
                                </label>
                                <input
                                    type="text"
                                    id="newClientName"
                                    required
                                />
                            </div>
                            <div class="form-group">
                                <label for="newClientPhone">
                                    Tel√©fono
                                    <span class="required">*</span>
                                </label>
                                <input
                                    type="tel"
                                    id="newClientPhone"
                                    required
                                />
                            </div>
                            <div class="form-group">
                                <label for="newClientEmail"> Email </label>
                                <input type="email" id="newClientEmail" />
                            </div>
                            <div class="form-group form-group-full">
                                <label for="newClientAddress">
                                    Direcci√≥n
                                    <span class="required">*</span>
                                </label>
                                <textarea
                                    id="newClientAddress"
                                    rows="2"
                                    required
                                ></textarea>
                            </div>
                        </div>
                        <div class="form-actions">
                            <button
                                type="button"
                                class="btn-primary"
                                onclick="saveNewClient()"
                            >
                                Guardar Cliente
                            </button>
                            <button
                                type="button"
                                class="btn-secondary"
                                onclick="cancelNewClient()"
                            >
                                Cancelar
                            </button>
                        </div>
                    </div>

                    <!-- Lista de clientes -->
                    <div id="clientsContainer" class="clients-list">
                        <!-- Aqu√≠ se mostrar√°n los clientes -->
                    </div>
                </div>
            </section>

            <!-- Pesta√±a: Gesti√≥n de Pedidos -->
            <section class="tab-content" id="orders">
                <div class="form-container">
                    <h2>Pedidos Registrados</h2>
                    <div class="orders-actions">
                        <button
                            type="button"
                            class="btn-primary"
                            id="loadOrdersBtn"
                            onclick="loadOrders()"
                        >
                            Cargar Pedidos
                        </button>
                        <button
                            type="button"
                            class="btn-secondary"
                            id="exportPdfBtn"
                            onclick="exportOrdersToPDF()"
                        >
                            üíæ Exportar PDF
                        </button>
                    </div>
                    <div id="ordersContainer" class="orders-list">
                        <!-- Aqu√≠ se mostrar√°n los pedidos -->
                    </div>
                </div>
            </section>

            <!-- Pesta√±a: Dashboard de Reportes -->
            <section class="tab-content" id="reports">
                <div class="form-container">
                    <div class="reports-header">
                        <h2>üìä Dashboard de Ventas</h2>
                        <div class="reports-actions">
                            <div class="date-filter">
                                <label for="filterStartDate">Desde:</label>
                                <input type="date" id="filterStartDate" />
                                <label for="filterEndDate">Hasta:</label>
                                <input type="date" id="filterEndDate" />
                                <button
                                    type="button"
                                    class="btn-primary btn-small"
                                    onclick="applyDateFilter()"
                                >
                                    Filtrar
                                </button>
                                <button
                                    type="button"
                                    class="btn-secondary btn-small"
                                    onclick="clearDateFilter()"
                                >
                                    Limpiar
                                </button>
                            </div>
                            <button
                                type="button"
                                class="btn-secondary"
                                onclick="toggleReportsSection()"
                            >
                                Cerrar
                            </button>
                        </div>
                    </div>

                    <!-- Tarjetas de Estad√≠sticas -->
                    <div class="stats-grid">
                        <div class="stat-card stat-card-primary">
                            <div class="stat-icon">üí∞</div>
                            <div class="stat-content">
                                <h3>Total Ventas</h3>
                                <p class="stat-value" id="totalSales">$ 0</p>
                                <span class="stat-label">Ingresos totales</span>
                            </div>
                        </div>

                        <div class="stat-card stat-card-success">
                            <div class="stat-icon">üìã</div>
                            <div class="stat-content">
                                <h3>Pedidos</h3>
                                <p class="stat-value" id="totalOrders">0</p>
                                <span class="stat-label"
                                    >Pedidos realizados</span
                                >
                            </div>
                        </div>

                        <div class="stat-card stat-card-info">
                            <div class="stat-icon">üë•</div>
                            <div class="stat-content">
                                <h3>Clientes</h3>
                                <p class="stat-value" id="totalClients">0</p>
                                <span class="stat-label">Clientes √∫nicos</span>
                            </div>
                        </div>

                        <div class="stat-card stat-card-warning">
                            <div class="stat-icon">üìà</div>
                            <div class="stat-content">
                                <h3>Promedio</h3>
                                <p class="stat-value" id="avgOrderValue">$ 0</p>
                                <span class="stat-label">Por pedido</span>
                            </div>
                        </div>
                    </div>

                    <!-- Gr√°ficos y Tablas -->
                    <div class="reports-grid">
                        <!-- Productos M√°s Vendidos -->
                        <div class="report-card">
                            <h3>üèÜ Productos M√°s Vendidos</h3>
                            <div id="topProductsChart" class="chart-container">
                                <!-- Gr√°fico generado din√°micamente -->
                            </div>
                        </div>

                        <!-- Clientes Frecuentes -->
                        <div class="report-card">
                            <h3>‚≠ê Clientes Frecuentes</h3>
                            <div id="topClientsChart" class="chart-container">
                                <!-- Tabla generada din√°micamente -->
                            </div>
                        </div>

                        <!-- Ventas por Categor√≠a -->
                        <div class="report-card">
                            <h3>üìä Ventas por Categor√≠a</h3>
                            <div
                                id="categorySalesChart"
                                class="chart-container"
                            >
                                <!-- Gr√°fico generado din√°micamente -->
                            </div>
                        </div>

                        <!-- Ventas por Fecha -->
                        <div class="report-card">
                            <h3>üìÖ Tendencia de Ventas</h3>
                            <div id="salesTrendChart" class="chart-container">
                                <!-- Gr√°fico de l√≠neas generado din√°micamente -->
                            </div>
                        </div>
                    </div>

                    <!-- Tabla Detallada -->
                    <div class="report-card report-card-full">
                        <h3>üìã Detalle de Pedidos</h3>
                        <div class="table-responsive">
                            <table id="ordersDetailTable" class="data-table">
                                <thead>
                                    <tr>
                                        <th>Fecha</th>
                                        <th>Cliente</th>
                                        <th>Productos</th>
                                        <th>Cantidad</th>
                                        <th>Total</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <!-- Filas generadas din√°micamente -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Mensajes de estado -->
            <div
                id="statusMessage"
                role="status"
                aria-live="polite"
                aria-atomic="true"
                class="status-message"
            ></div>
        </main>

        <footer role="contentinfo">
            <div class="footer-content">
                <img
                    src="assets/images/logo-purple-shop.png"
                    alt="Purple Shop"
                    class="footer-logo"
                />
                <div class="footer-text">
                    <h3>Purple Shop</h3>
                    <p>
                        Sistema de Registro de Pedidos de Accesorios, Medias,
                        Camisetas, Perfumes o Lociones
                    </p>
                    <p class="copyright">
                        &copy; 2025 Purple Shop - Todos los derechos reservados
                    </p>
                </div>
            </div>
        </footer>

        <!-- Scripts -->
        <script src="https://alcdn.msauth.net/browser/2.30.0/js/msal-browser.min.js"></script>
        <script src="js/app.js"></script>
    </body>
</html>
